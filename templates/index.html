{% extends 'base.html' %}
{% block content %}
    <form id="upload" method="post" action="{{url_for('index')}}" enctype="multipart/form-data">
        {{ form.hidden_tag() }}
        <div class="form-group {% if form.photo.errors %} has-error {% endif %}">
        {{ form.photo.label }}{{ form.photo(class='form-control') }}
        {% if form.photo.errors %}
            <ul class="errors">
                {% for error in form.photo.errors %}
                    <li>{{ error }}</li>
                {% endfor %}
            </ul>
        {% endif %}
        </div><!-- /.form-group -->
        <div class="progress" style="display:none;">
            <div class="progress-bar" role="progressbar" aria-valuenow="60" aria-valuemin="0" aria-valuemax="100" style="width: 0%;">
                <span class="sr-only">0% Complete</span>
            </div>
        </div>
        <input type="submit" class="btn btn-default" value="Upload">
    </form>
{% endblock %}
{% block script %}
<script>
    var progressHandler = function(e) {
        if(e.lengthComputable){
            var value = (e.loaded / e.total) * 100;
            var bar = $('#upload .progress-bar');
            bar.css('width', value + '%');
            bar.attr('aria-valuenow', value);
            bar.children('.sr-only').html(value + '% Complete')
        }
    }
    
    var successHandler = function(data) {
        console.log(data);
    };
    
    var errorHandler = function(e) {
    
    };

    var form = $('#upload');
    
    form.submit(function(event){
        
        console.log('event');
        event.preventDefault();
        var formData = new FormData(form[0]);
        $('#photo').hide();
        $('#upload .progress').show();
        $.ajax({
            url: '/',  //Server script to process data
            type: 'POST',
            xhr: function() {  // Custom XMLHttpRequest
                var x = $.ajaxSettings.xhr();
                if(x.upload){ // Check if upload property exists
                    x.upload.addEventListener('progress', progressHandler, false); // For handling the progress of the upload
                }
                return x;
            },
            // Form data
            dataType: 'json',
            data: formData,
            //Options to tell jQuery not to process data or worry about content-type.
            cache: false,
            contentType: false,
            processData: false
        }).then(successHandler, errorHandler);
    });
</script>
{% endblock %}
